<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Session Calendar</title>
    <link rel="icon" type="image/png" href="favicon.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        wcg: {
                            blue: '#004B87',
                            grey: '#968C83',
                            red: '#EE3B3B',
                            yellow: '#FFD700',
                            green: '#32CD32',
                            darkText: '#333333',
                            lightBg: '#F3F4F6'
                        }
                    },
                    fontFamily: {
                        sans: ['Century Gothic', 'Didact Gothic', 'Segoe UI', 'sans-serif'],
                        accent: ['Gotham', 'Montserrat', 'sans-serif']
                    }
                }
            }
        }
    </script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Didact+Gothic&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { -webkit-font-smoothing: antialiased; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
        .spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* 5-Column Grid (Mon-Fri) */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0;
            background-color: #e5e7eb;
        }
        
        .calendar-day-cell {
            background-color: white;
            min-height: 140px;
            padding: 10px;
            position: relative;
            border: 1px solid #e5e7eb;
        }
        
        @media (max-width: 768px) { .calendar-day-cell { min-height: 100px; padding: 6px; } }
        
        /* Level Borders */
        .level-foundation { border-left: 4px solid #32CD32 !important; }
        .level-better { border-left: 4px solid #EE3B3B !important; }
        .level-can { border-left: 4px solid #FFD700 !important; }
        .level-summit { border-left: 4px solid #004B87 !important; }
        
        .session-pill { transition: all 0.2s ease; cursor: pointer; }
        .session-pill:hover { transform: translateY(-1px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .other-month-cell { background-color: #fafafa; }
        .today-cell { background-color: #eff6ff; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; display: flex; align-items: center; justify-content: center; padding: 16px; }
        .modal-content { background: white; border-radius: 12px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
        .live-dot { width: 8px; height: 8px; background: #EE3B3B; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    </style>
</head>
<body class="bg-gray-50 text-wcg-darkText font-sans">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        const Icons = {
            Calendar: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Grid: () => <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>,
            Search: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>,
            Filter: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>,
            ChevronDown: ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>,
            ChevronLeft: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m15 18-6-6 6-6"/></svg>,
            ChevronRight: () => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6"/></svg>,
            Clock: () => <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
            Video: () => <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 8-6 4 6 4V8Z"/><rect width="14" height="12" x="2" y="6" rx="2" ry="2"/></svg>,
            Loader: () => <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className="spin"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        };

        const parseDate = (d) => {
            if (!d) return new Date(8640000000000000);
            const p = d.split('/');
            return p.length === 3 ? new Date(p[2], p[1] - 1, p[0]) : new Date(d);
        };

        const isToday = (d) => {
            const t = new Date();
            return d.getDate() === t.getDate() && d.getMonth() === t.getMonth() && d.getFullYear() === t.getFullYear();
        };

        const isPast = (d) => {
            const t = new Date(); t.setHours(0,0,0,0);
            const c = new Date(d); c.setHours(0,0,0,0);
            return c < t;
        };

        const Badge = ({ children, type }) => {
            let cls = 'bg-gray-100 text-gray-700 border-gray-200';
            const val = (children || '').toLowerCase();
            if (type === 'level') {
                if (val.includes('foundation')) cls = 'bg-wcg-green text-white border-wcg-green';
                else if (val.includes('better')) cls = 'bg-wcg-red text-white border-wcg-red';
                else if (val.includes('i can')) cls = 'bg-wcg-yellow text-gray-900 border-wcg-yellow';
                else if (val.includes('summit')) cls = 'bg-wcg-blue text-white border-wcg-blue';
            } else if (type === 'district') cls = 'bg-white text-wcg-blue border-wcg-blue/30 border';
            return <span className={`px-2 py-0.5 rounded-md text-[10px] font-bold uppercase border ${cls}`}>{children}</span>;
        };

        const SessionModal = ({ session, onClose }) => {
            const d = parseDate(session.date);
            const past = isPast(d);
            return (
                <div className="modal-overlay" onClick={onClose}>
                    <div className="modal-content fade-in" onClick={e => e.stopPropagation()}>
                        <div className={`p-4 border-b flex justify-between items-center ${past ? 'bg-gray-100' : 'bg-gray-50'}`}>
                            <div>
                                <div className="flex items-center gap-2 font-bold text-wcg-blue">
                                    <Icons.Calendar /><span>{d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric', month: 'short' })}</span>
                                </div>
                                <div className="text-sm text-gray-500 ml-6">{session.time}</div>
                            </div>
                            <button onClick={onClose} className="text-2xl text-gray-400">&times;</button>
                        </div>
                        <div className="p-5">
                            <Badge type="level">{session.level}</Badge>
                            <h3 className="text-xl font-bold mt-2 mb-4">{session.name}</h3>
                            <p className="text-sm text-gray-600 leading-relaxed mb-6">{session.description}</p>
                            {!past && (
                                <div className="space-y-3">
                                    {isToday(d) && session.joinLink ? (
                                        <a href={session.joinLink} target="_blank" className="block text-center bg-wcg-red text-white font-bold p-3 rounded-lg shadow-lg"><Icons.Video /> JOIN NOW</a>
                                    ) : (
                                        <a href={session.registerLink} target="_blank" className="block text-center bg-wcg-blue text-white font-bold p-3 rounded-lg">Register Now</a>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SessionPill = ({ session, onClick }) => {
            const d = parseDate(session.date);
            const past = isPast(d);
            const live = isToday(d) && session.joinLink && !past;
            const level = (session.level || '').toLowerCase();
            const levelClass = level.includes('foundation') ? 'level-foundation' : level.includes('better') ? 'level-better' : level.includes('i can') ? 'level-can' : level.includes('summit') ? 'level-summit' : '';
            
            return (
                <div onClick={onClick} className={`session-pill mb-1.5 p-2 rounded border text-xs ${levelClass} ${past ? 'bg-gray-50 text-gray-400' : live ? 'bg-red-50 border-red-200' : 'bg-white border-gray-200 shadow-sm'}`}>
                    <div className="font-bold leading-tight mb-1">{session.name}</div>
                    <div className="flex items-center gap-1 opacity-70"><Icons.Clock />{session.time}</div>
                    {live && <div className="mt-1 text-wcg-red font-bold flex items-center gap-1"><span className="live-dot"></span> LIVE</div>}
                </div>
            );
        };

        const CalendarView = ({ sessions, currentMonth, setCurrentMonth }) => {
            const [selected, setSelected] = useState(null);
            
            const days = useMemo(() => {
                const first = new Date(currentMonth.getFullYear(), currentMonth.getMonth(), 1);
                const last = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 0);
                
                // Adjust Monday start (0=Mon, 4=Fri)
                let startOffset = first.getDay();
                startOffset = startOffset === 0 ? 6 : startOffset - 1;

                const grid = [];
                let cursor = new Date(first);
                cursor.setDate(first.getDate() - startOffset);

                // Fill weeks (Mon-Fri)
                while (grid.length < 25 || cursor <= last) {
                    if (cursor.getDay() !== 0 && cursor.getDay() !== 6) {
                        const dKey = `${cursor.getFullYear()}-${cursor.getMonth()}-${cursor.getDate()}`;
                        grid.push({
                            date: new Date(cursor),
                            isCurrent: cursor.getMonth() === currentMonth.getMonth(),
                            sessions: sessions.filter(s => {
                                const sd = parseDate(s.date);
                                return sd.getDate() === cursor.getDate() && sd.getMonth() === cursor.getMonth() && sd.getFullYear() === cursor.getFullYear();
                            })
                        });
                    }
                    cursor.setDate(cursor.getDate() + 1);
                    if (grid.length >= 35 && cursor > last) break; 
                }
                return grid;
            }, [currentMonth, sessions]);

            return (
                <div className="fade-in">
                    {selected && <SessionModal session={selected} onClose={() => setSelected(null)} />}
                    <div className="bg-white rounded-xl shadow-sm border p-4 mb-6 flex items-center justify-between">
                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() - 1, 1))} className="p-2 hover:bg-gray-100 rounded-lg"><Icons.ChevronLeft /></button>
                        <h2 className="text-xl md:text-2xl font-bold text-wcg-blue font-accent">{currentMonth.toLocaleString('default', { month: 'long', year: 'numeric' })}</h2>
                        <button onClick={() => setCurrentMonth(new Date(currentMonth.getFullYear(), currentMonth.getMonth() + 1, 1))} className="p-2 hover:bg-gray-100 rounded-lg"><Icons.ChevronRight /></button>
                    </div>
                    <div className="bg-white rounded-xl shadow-lg border overflow-hidden">
                        <div className="calendar-grid bg-gray-50 border-b">
                            {['Mon', 'Tue', 'Wed', 'Thu', 'Fri'].map(d => <div key={d} className="p-3 text-center font-bold text-xs text-gray-500 uppercase tracking-wider">{d}</div>)}
                        </div>
                        <div className="calendar-grid">
                            {days.map((day, i) => (
                                <div key={i} className={`calendar-day-cell ${!day.isCurrent ? 'other-month-cell' : ''} ${isToday(day.date) ? 'today-cell' : ''}`}>
                                    <div className={`text-xs font-bold mb-2 ${day.isCurrent ? 'text-gray-700' : 'text-gray-300'}`}>{day.date.getDate()}</div>
                                    {day.sessions.map((s, si) => <SessionPill key={si} session={s} onClick={() => setSelected(s)} />)}
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState([]);
            const [loading, setLoading] = useState(true);
            const [expanded, setExpanded] = useState(false);
            const [filters, setFilters] = useState({ search: '', district: 'All' });
            const [currentMonth, setCurrentMonth] = useState(new Date());

            useEffect(() => {
                Papa.parse('Upcoming Sessions - Scheduled Sessions.csv', {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (r) => {
                        setData(r.data.map((row, i) => ({
                            id: i,
                            date: row['Date'],
                            time: row['Time'],
                            district: row['HOSTING DISTRICT'] || 'Unspecified',
                            name: row['Session Name'],
                            level: row['Developmental Level'],
                            description: row['Session Description'] || row['Session Desciption'],
                            registerLink: row['Pre-Register'],
                            joinLink: row['Join Link']
                        })).filter(s => s.name));
                        setLoading(false);
                    },
                    error: () => setLoading(false)
                });
            }, []);

            const filtered = useMemo(() => {
                return data.filter(s => {
                    const matchesSearch = s.name.toLowerCase().includes(filters.search.toLowerCase());
                    const matchesDist = filters.district === 'All' || s.district === filters.district;
                    return matchesSearch && matchesDist;
                });
            }, [data, filters]);

            const districts = ['All', ...new Set(data.map(s => s.district).filter(Boolean).sort())];

            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center text-wcg-blue"><Icons.Loader /><p className="mt-4 font-bold">Loading Calendar...</p></div>;

            return (
                <div className="min-h-screen pb-12">
                    <header className="bg-white border-b sticky top-0 z-30 shadow-sm">
                        <div className="max-w-7xl mx-auto px-4 py-3 md:py-4">
                            <div className="flex items-center justify-between gap-4">
                                <div className="flex items-center gap-3">
                                    <img src="header.png" alt="WCG" className="h-10 md:h-14" />
                                    <a href="index.html" className="hidden sm:flex items-center gap-2 px-3 py-1.5 bg-gray-100 rounded-lg text-xs font-bold"><Icons.Grid /> Tiles</a>
                                </div>

                                <button onClick={() => setExpanded(!expanded)} className="md:hidden flex items-center gap-2 px-4 py-2 bg-wcg-blue text-white rounded-full text-xs font-bold">
                                    <Icons.Filter /> Filters <Icons.ChevronDown className={`transition-transform ${expanded ? 'rotate-180' : ''}`} />
                                </button>

                                <div className="hidden md:block relative w-96">
                                    <div className="absolute inset-y-0 left-0 pl-3 flex items-center text-gray-400"><Icons.Search /></div>
                                    <input type="text" placeholder="Search sessions..." className="w-full pl-10 pr-4 py-2 border rounded-full bg-gray-50 text-sm focus:ring-1 focus:ring-wcg-blue outline-none" value={filters.search} onChange={e => setFilters({...filters, search: e.target.value})} />
                                </div>
                            </div>

                            <div className={`${expanded ? 'block animate-slide-down' : 'hidden'} md:block mt-4 pt-4 border-t`}>
                                <div className="flex flex-wrap gap-3 items-center">
                                    <div className="md:hidden w-full relative mb-2">
                                        <input type="text" placeholder="Search..." className="w-full pl-4 pr-4 py-2 border rounded-lg bg-gray-50 text-sm" value={filters.search} onChange={e => setFilters({...filters, search: e.target.value})} />
                                    </div>
                                    <select value={filters.district} onChange={e => setFilters({...filters, district: e.target.value})} className="bg-white border px-3 py-2 rounded-lg text-sm font-medium outline-none">
                                        {districts.map(d => <option key={d} value={d}>{d === 'All' ? 'All Districts' : d}</option>)}
                                    </select>
                                    {(filters.search || filters.district !== 'All') && (
                                        <button onClick={() => setFilters({search: '', district: 'All'})} className="text-xs font-bold text-wcg-red uppercase ml-auto">Clear Filters</button>
                                    )}
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-4 py-8">
                        {filtered.length === 0 ? (
                            <div className="text-center py-20 bg-white rounded-xl border-2 border-dashed">
                                <h3 className="text-lg font-bold">No sessions match your filters</h3>
                                <button onClick={() => setFilters({search: '', district: 'All'})} className="mt-4 text-wcg-blue font-bold uppercase text-xs">Reset All</button>
                            </div>
                        ) : (
                            <CalendarView sessions={filtered} currentMonth={currentMonth} setCurrentMonth={setCurrentMonth} />
                        )}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
